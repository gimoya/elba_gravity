<html>
<head>

<title>ELBA GRAVITY PARK</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="//unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
	
	<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script src='//api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<script src="//lightwidget.com/widgets/lightwidget.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="//unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
	
	<!-- Locate Control -->
	<link rel="stylesheet" href="Styles/L.Control.Locate.min.css" />
	<script src="Scripts/L.Control.Locate.min.js" charset="utf-8"></script>
	<!-- Locate Control -->
	
	<!-- GOOGLE FONTS -->	
	<link href='//fonts.googleapis.com/css?family=Bangers|Fugaz+One|Hanalei|Ranga|Ultra|Exo:Bold|Fredoka+One|Sigmar+One|Bungee+Inline|Creepster|Ewert|Fruktur|Monoton|Rubik:900' rel='stylesheet' type='text/css'>	
	<!-- GOOGLE FONTS -->		
	
    <style type="text/css">
	    
	html, body {
		font-size: 100%;
		height: 100%;
		padding: 0;
		margin: 0;
	}
	    
	#map {
		position: absolute;
		width: 100%;
		height: 100%;
	}	    
	    
	.awesome-marker i {
	    font-size: 18px;
	    margin-top: 10px;
	}
	    
	.custom-control {
		font-family: Exo;
	}
	
	/* 
	hack to fix fa-marker position in geo-location control
	*/
	span.fa-map-marker.fa {
		margin-top: 5px;
	}
	

	
	/*
	exceptation for control links.. not working?
	*/
	.leaflet-bar a {
	    color: darkslategrey;
	}
	    
	#infopanel-bottom {		
		position: absolute;
		display: none;
		width: 100%;
		max-height: 70%;
		overflow-y: scroll;
		bottom: 0px;
		right: 0px;
		z-index: 999; 
		background-color: rgba(255,255,255,1);	
		color: #999;
	}

	.info-row {
		width: 100%;
		padding: 10 0 0 10px;
	}  
	    
	#title, #poi-info, #tracks {
		font-family: 'Corbel';
	}

	#title {
		font-size: 2.5em;
	}
	
	#poi-info {
		font-size: 2em;
	}
	
	#tracks {
		font-size: 1.5em;
	}

   .IT, .EN {
		max-height: 7em;
		overflow-y: scroll;
	}
	
   .IT {
	  display: block;
	}

	.EN {
	  display: none;
	}

	/* 
	custom link styling:
	*/
	
	a, .Text-Click {
	   cursor: hand; 
	   transition: color .4s;
	}
	
	a, .Text-Click, .Text-Click:visited { 
		color: #ccba38; 
	}

	a:hover, .Text-Click:hover  { color: #7FDBFF; }
	
	a:active, .Text-Click:active  {
		transition: color .3s;
		color: #007BE6;
	}	
	
	/* 
	CSS for inline close element which will hide it's parent div if clicked..
	*/
	#close {
		color: white;
		font-family: Corbel;
		float: right;
		display: inline-block;
		padding: 5px 10px;
		background: #ccc;
		cursor: hand;
	}
	#close:hover {
		background: #aaa;
	}
	
	/*
	Phot Gallery Stuff
	*/
	
	</style>
</head> 		
	
<body>
	<div id="photo-gallery"></div>
	<div id="infopanel-bottom">
		<div id="close" title="Click to close" onclick="$(this).parent().fadeOut('slow');">X</div>
		<div id="trail-container">
			<div class="info-row" id="title"></div>
			<div class="info-row" id="trail-info"></div>
			<div class="Text-Click" id="photo-slider-click" onclick="alert('Poh')">Gallery</div>
			<div class="info-row" id="tracks"><a id="gpx" href="" download>GPX</a> | <a id="kml" href="" download>KML</a></div>		
		</div>
		<div class="info-row" id="poi-info"></div>
		<div class="info-row" id="spacer-bottom" style="height:1em;"></div>
	</div>
	
	<div id="map"></div>
	
	<script language="javascript">
		
		var map = L.map('map', {
		  center: [42.808660, 10.393714],
		  zoom: 13,
		  maxZoom: 17,
		  minZoom: 11,
		  zoomControl: false,
		  attributionControl: false
		});
		
		new L.control.attribution({position: 'bottomright'}).addTo(map);
		new L.Control.Zoom({ position: 'topright' }).addTo(map);

		var toggle = L.easyButton({
		  position: 'topright',
		  states: [{
			stateName: 'basemap-outdoor',
			icon: '<span class="custom-control">T</span>',
			title: 'change basemap back to satellite',		
			onClick: function(control) {
			  map.removeLayer(mapbox_outdoorLayer);
			  map.addLayer(mapbox_satelliteLayer);
			  control.state('basemap-satellite');
			}
		  }, {
			stateName: 'basemap-satellite',
			icon: '<span class="custom-control">S</span>',
			title: 'change basemap to outdoor/terrain',
			onClick: function(control) {
			  map.removeLayer(mapbox_satelliteLayer);
			  map.addLayer(mapbox_outdoorLayer);
			  control.state('basemap-outdoor');
			},
		  }]
		});	

		toggle.addTo(map);

		L.control.locate({
			strings: {
				title: "Show me where I am, yo!"
			}

		}).addTo(map);

		var mapbox_Attr = 'Tiles &copy; <a href="https://www.mapbox.com">mapbox</a>';  
		var mapbox_satelliteUrl = 'https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2ltb3lhIiwiYSI6IkZrTld6NmcifQ.eY6Ymt2kVLvPQ6A2Dt9zAQ';
		var mapbox_outdoorUrl = 'https://api.mapbox.com/styles/v1/mapbox/outdoors-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZ2ltb3lhIiwiYSI6IkZrTld6NmcifQ.eY6Ymt2kVLvPQ6A2Dt9zAQ';

		var mapbox_satelliteLayer = L.tileLayer(mapbox_satelliteUrl, {
		  attribution: mapbox_Attr 
		});

		var mapbox_outdoorLayer = L.tileLayer(mapbox_outdoorUrl, {
		  attribution: mapbox_Attr 
		});		

		mapbox_outdoorLayer.addTo(map);		
		
		var trailColors = {
			"Miniere": "#6dc066",
			"Strega": "#ffd700", 
			"Mezza Strega": "#ff0000",
			"Scalette": "#66cccc",
			"Vignola": "#8a2be2",
			"Cavo": "#0099cc",
			"Serra": "#ffb6c1",
			"Buca Del Bandito": "#000000"
		};
		
		function trailClick(e, font) {
			$("#poi-info").css('display', 'none');
			// this will show #title and #tracks in #trail-container again, if its display was set to none after clicked #poi-info
			$("#trail-container").css('display', 'block'); 		
			$("#title").css('font-family', font)
				.css('color', trailColors[e.layer.feature.properties.name])
				.html(e.layer.feature.properties.name);
			$("#trail-info").html(e.layer.feature.properties.description + '<a href="https://instagram.com/explore/tags/ElbaGravity_' + e.layer.feature.properties.name.replace(/\s+/g, '') + '" target="_blank">Check on Instagram</a>');
			// This elements are coded into the KMLs!
			$("#IT-Click").on('click', function() {
				$(".EN").css("display", "none");
				$(".IT").css("display", "block");
			});	
			$("#EN-Click").on('click', function() {
				$(".IT").css("display", "none");
				$(".EN").css("display", "block");
			});				
			$("#tracks").css('display', 'block');
			$("#infopanel-bottom").fadeIn("slow");			
			map.fitBounds(e.layer.getBounds());
		}

		// use one version of the kml layers for outline styling	
		var CavoKML_outline = omnivore.kml('KML/Cavo.kml');		
		var SerraKML_outline = omnivore.kml('KML/Serra.kml');
		var BucaDelBanditoKML_outline = omnivore.kml('KML/BucaDelBandito.kml');
		var MiniereKML_outline = omnivore.kml('KML/Miniere.kml');
		var MezzaStregaKML_outline = omnivore.kml('KML/MezzaStrega.kml');
		var StregaKML_outline = omnivore.kml('KML/Strega.kml');
		var ScaletteKML_outline = omnivore.kml('KML/Scalette.kml');
		var VignolaKML_outline = omnivore.kml('KML/Vignola.kml');
		
		var groupKML_outline = new L.LayerGroup([
			SerraKML_outline,
			MiniereKML_outline,
			BucaDelBanditoKML_outline,	
			MezzaStregaKML_outline,
			ScaletteKML_outline,
			StregaKML_outline,
			VignolaKML_outline,
			CavoKML_outline
		]);
		
		groupKML_outline.eachLayer(function (layer) {	
			layer.on('ready', function() { 			
				layer.setStyle({
					'color': 'white',
					'weight': 8					
				});
			});	
		});

		// this version of lines will be put on top of the white base version lines
		// resulting in a coloured line with white outline
		var CavoKML = omnivore.kml('KML/Cavo.kml')
			.on('click', function(e) {
				trailClick(e, "Bangers");
				$("#gpx").prop('href', 'GPX/Cavo.gpx');
				$("#kml").prop('href', 'KML/Cavo.kml');
			});
		
		var SerraKML = omnivore.kml('KML/Serra.kml')
			.on('click', function(e) {
				trailClick(e, "Fruktur");
				$("#gpx").prop('href', 'GPX/Serra.gpx');
				$("#kml").prop('href', 'KML/Serra.kml');
			});

		var BucaDelBanditoKML = omnivore.kml('KML/BucaDelBandito.kml')
			.on('click', function(e) {
				trailClick(e, "Creepster");
				$("#gpx").prop('href', 'GPX/BucaDelBandito.gpx');
				$("#kml").prop('href', 'KML/BucaDelBandito.kml');
			});

		var MiniereKML = omnivore.kml('KML/Miniere.kml')
			.on('click', function(e) {
				trailClick(e, "Ultra");
				$("#gpx").prop('href', 'GPX/Miniere.gpx');
				$("#kml").prop('href', 'KML/Miniere.kml');
			});		

		var MezzaStregaKML = omnivore.kml('KML/MezzaStrega.kml')
			.on('click', function(e) {
				trailClick(e, "Ewert");
				$("#gpx").prop('href', 'GPX/MezzaStrega.gpx');
				$("#kml").prop('href', 'KML/MezzaStrega.kml');
			});

		var StregaKML = omnivore.kml('KML/Strega.kml', null)
			.on('click', function(e) {
				trailClick(e, "Fugaz One");
				$("#gpx").prop('href', 'GPX/Strega.gpx');
				$("#kml").prop('href', 'KML/Strega.kml');
			});

		var ScaletteKML = omnivore.kml('KML/Scalette.kml')
			.on('click', function(e) {
				trailClick(e, "Hanalei");
				$("#gpx").prop('href', 'GPX/Scalette.gpx');
				$("#kml").prop('href', 'KML/Scalette.kml');
			});

		var VignolaKML = omnivore.kml('KML/Vignola.kml')
			.on('click', function(e) {
				trailClick(e, "Bungee Inline");
				$("#gpx").prop('href', 'GPX/Vignola.gpx');
				$("#kml").prop('href', 'KML/Vignola.kml');
			});
		
		/*
		For highlighting features see:
		http://stackoverflow.com/questions/32971673/how-do-you-make-a-highlighted-outline-appear-in-leaflet-js-on-mouseover-and-by-h
		*/	

		var style = {
			'default': {
				'weight': 5,
				'opacity': 0.4
			},
			'highlight': {
				'weight': 7,
				'opacity': 0.6
			}
		};

		// Variable for storing highlighted layer
		var highlight;

		function setHighlight (layer) {
		  // Check if something's highlighted, if so unset highlight
		  if (highlight) {
			unsetHighlight(highlight);
		  }
		  // Set highlight style on layer and store to variable
		  layer.setStyle(style.highlight);
		  highlight = layer;
		}

		function unsetHighlight (layer) {
		  // Set default style and clear variable
		  layer.setStyle(style.default);
		  highlight = null;
		}

		var groupKML = new L.LayerGroup([
			CavoKML,
			SerraKML,
			MiniereKML,
			BucaDelBanditoKML,	
			MezzaStregaKML,
			ScaletteKML,
			StregaKML,
			VignolaKML
		]);

		map.addLayer(groupKML_outline);
		map.addLayer(groupKML);
		
		// used icons for markers:
		L.AwesomeMarkers.Icon.prototype.options.prefix = 'fa';
		  
		var bikeLoadingIcon = L.AwesomeMarkers.icon({
			    icon: 'fa-truck',
			    markerColor: 'purple',
			    iconColor: 'yellow'
			  })			

		function showTelDario(e) {
			$("#poi-info").html('Shuttle Call <a href="tel:+39 320 264 9391">+39 320 264 9391</a>');
			$("#poi-info").css('display', 'block');
			// this will hide #title and #tracks in #trail-container, which otherwise would always stick above #poi-info		
			$("#trail-container").css('display','none');
			$("#infopanel-bottom").fadeIn("slow");
			// console.log(latLngToLayerPoint(e.latlng));
		}
		
		var bikeLoadingPts = [
			[42.810156, 10.363514],
			[42.799289, 10.357636],
			[42.860381, 10.420435],
			[42.843782, 10.400274],
			[42.770250, 10.390604],
			[42.815970, 10.428423]
		];
		
		var loadingPtsLabels = ['Bagnaia', 'Magazzini', 'Cavo', 'SP 33 - Vignola Exit', 'Porto Azzurro', 'Rio Marina'];

		
		for (i = 0; i < bikeLoadingPts.length; i++) { 
			new L.marker(bikeLoadingPts[i], {icon: bikeLoadingIcon})
				.bindTooltip(loadingPtsLabels[i], 
					{
						permanent: false, 
						direction: 'right'
					}
				)
				.on('click', showTelDario)
				.addTo(map);
		}
		
		// Bike Rent marker and functionally disabled, October 2018..
		/* 		
		var bikeRentIcon = L.AwesomeMarkers.icon({
			    icon: 'fa-bicycle',
			    markerColor: 'blue',
			    iconColor: 'yellow'
			  });	
			  
		function openShopURL(e) {
			$("#poi-info").html('Visit <a href="http://www.elbagravitybikerent.it/" target="_blank";>Elba Gravity Bike Shop/Rent</a>');
			$("#poi-info").css('display', 'block');
			// this will hide #title and #tracks in #trail-container, which otherwise would always stick above #poi-info	
			$("#trail-container").css('display','none');
			$("#infopanel-bottom").fadeIn("slow");
			// console.log(latLngToLayerPoint(e.latlng));			
		}

		new L.marker([42.81376, 10.3989717], {icon: bikeRentIcon})
			.on('click', openShopURL)
			.addTo(map);
		*/	
		
		
		// Iterate over groupKML and make end and start markers, then attach event listeners..	
		groupKML.eachLayer(function (layer) {	

			layer.on('ready', function() { 
				var name = layer.getLayers(0)[0].feature.properties.name;
				var latlngs = layer.getLayers(0)[0]._latlngs;
				
				layer.setStyle({
					'weight': 5,
					'color': trailColors[name]
				});				
				
				new L.circleMarker(latlngs[0], {
						color: 'darkslategrey',
						fillColor: 'lightgreen',
						fillOpacity: 1,					
						radius: 8
					})
					.bindTooltip(name + ' - Start', {
						permanent: false, 
						direction: 'right'
					})
					.addTo(map);
					
				new L.circleMarker(latlngs[latlngs.length - 1], {
						color: 'darkslategrey',
						fillColor: 'pink',
						fillOpacity: 1,
						radius: 8
					})
					.bindTooltip(name + ' - End', {
						permanent: false, 
						direction: 'right'
					})
					.addTo(map);
			});			
		});
	</script>
</body>	
</html>
